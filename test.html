<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Collada Animation Loader/Converter</title>
    <style>
        label {
            line-height: normal;
            flex: 0 0 75px;
            border-radius: 2px 0 0 2px;
            border: 1px solid rgba(147,128,108,.25);
            padding: .5em .75em;
            background-color: rgba(147,128,108,.1);
            color: #666;
            font-weight: 400;
            margin-left: 0.5em;
        }

        input, textarea {
            display: block;
            line-height: normal;
            flex: 1 0 100px;
            border-radius: 0 2px 2px 0;
            border: 1px solid rgba(147,128,108,.25);
            border-left: 0;
            padding: .5em .75em;
            margin: 0;
        }

        button {
             display: block;
            line-height: normal;
            flex: 1 0 100px;
            border-radius: 2px;
            border: 1px solid rgba(147,128,108,.25);
            padding: .5em .75em;
            margin: 0;
            margin-left: 0.5em;
        }

        #container {
            max-width: 70rem;
            flex:1;
            margin:0 auto;
        }

        .input-row {
            display: flex;
            flex-wrap: wrap;
        }

        .input-cell {
            display: flex;
            flex-wrap: wrap;
            flex:1 0 250px;
            margin-bottom: 0.5em;
        }

        body {
            display:flex;
        }
    </style>
	<script type="text/javascript" src="js/gl-matrix.js"></script>
    <script type="text/javascript" src="collada.js"></script>
    <script type="text/javascript">
        var elements = {};
        var xmlParser = null;
        var loader = null;
        var converter = null;
        var exporter = null;

        function writeProgress(msg) {
            elements.log_progress.textContent += msg + "\n";
            console.log(msg);
        }
        function clearInput() {
            elements.input.textContent = "";
        }
        function clearOutput() {
            elements.log_loader.textContent = "";
            elements.log_converter.textContent = "";
            elements.log_exporter.textContent = "";
            elements.output.textContent = "";
        }
        function onFileDrag(ev) {
            ev.preventDefault();
        }
        function onFileDrop(ev) {
            clearInput();
            writeProgress("Something dropped.");
            ev.preventDefault();
            var dt = ev.dataTransfer;
            var files = dt.files;
            if (files.length == 0) {
                writeProgress("You did not drop a file. Try dragging and dropping a file instead.");
                return;
            }
            if (files.length > 1) {
                writeProgress("You dropped multiple files. Please only drop a single file.");
                return;
            }
            var file = files[0];
            var reader = new FileReader();
            reader.onload = onFileLoaded;
            reader.onerror = onFileError;
            writeProgress("Reading dropped file...");
            reader.readAsText(file);
        }
        function onFileError() {
            writeProgress("Error reading file.");
        }
        function onFileLoaded(ev) {
            writeProgress("File reading finished.");
            var data = this.result;
            elements.input.textContent = data;
        }
        function onConvertClick() {
            clearOutput();

            // Input
            var input = elements.input.textContent;

            // Parse
            writeProgress("Starting XML parsing.");
            var parseStart = performance.now();
            var xmlDoc = xmlParser.parseFromString(input, "text/xml");
            var parseEnd = performance.now();
            writeProgress("Finished XML parsing (" + (parseEnd - parseStart).toFixed(2) + "ms).");

            // Load
            writeProgress("Starting COLLADA parsing.");
            var loadStart = performance.now();
            var loadData = loader.loadFromXML("id", xmlDoc);
            var loadEnd = performance.now();
            writeProgress("Finished COLLADA parsing (" + (loadEnd - loadStart).toFixed(2) + "ms).");
            console.log(loadData);

            // Convert
            writeProgress("Starting COLLADA conversion.");
            var convertStart = performance.now();
            var convertData = converter.convert(loadData);
            var convertEnd = performance.now();
            writeProgress("Finished COLLADA conversion (" + (convertEnd - convertStart).toFixed(2) + "ms).");
            console.log(convertData);

            // Export
            writeProgress("Starting COLLADA export.");
            var exportStart = performance.now();
            var exportData = exporter.export(convertData);
            var exportEnd = performance.now();
            writeProgress("Finished COLLADA export (" + (exportEnd - exportStart).toFixed(2) + "ms).");
            console.log(exportData);

            // Output
            elements.output.textContent = JSON.stringify(exportData.json, null, 2);
        }

        function onColladaProgress(id, loaded, total) {
            writeLog("Collada loading progress", "progress");
        }

        function init() {
            // Find elements
            elements.input = document.getElementById("input");
            elements.log_progress = document.getElementById("log_progress");
            elements.log_loader = document.getElementById("log_loader");
            elements.log_converter = document.getElementById("log_converter");
            elements.log_exporter = document.getElementById("log_exporter");
            elements.output = document.getElementById("output");
            elements.convert = document.getElementById("convert");

            // Create COLLADA converter chain
            xmlParser = new DOMParser();

            loader = new ColladaLoader();
            loader.log = new ColladaLogTextArea(elements.log_loader);

            converter = new ColladaConverter();
            converter.log = new ColladaLogTextArea(elements.log_converter);

            exporter = new ColladaExporter();  
            exporter.log = new ColladaLogTextArea(elements.log_exporter);

            // Register events
            elements.input.ondragover = onFileDrag;
            elements.input.ondrop = onFileDrop;
            elements.convert.onclick = onConvertClick;
        }
    </script>
</head>
<body>
    <div id="container">
        <div class="input-row input-cell">
            <label for="input">Input</label>
            <textarea id="input" rows="10" cols="40"></textarea>
        </div>
        <div class="input-row">
            <button id="convert" class="input-cell">Convert</button>
        </div>
        <div class="input-row">
            <div class="input-cell">
                <label for="log_progress">Progress</label>
                <textarea id="log_progress" rows="10" cols="20"></textarea>
            </div>
            <div class="input-cell">
                <label for="log_loader">Loader Log</label>
                <textarea id="log_loader" rows="10" cols="20"></textarea>
            </div>
        </div> 
        <div class="input-row">
            <div class="input-cell">
                <label for="log_converter">Converter Log</label>
                <textarea id="log_converter" rows="10" cols="40"></textarea>
            </div>
            <div class="input-cell">
                <label for="log_exporter">Exporter Log</label>
                <textarea id="log_exporter" rows="10" cols="40"></textarea>
            </div>
        </div>
        <div class="input-row input-cell">
            <label for="output">Output</label>
            <textarea id="output" rows="10" cols="40"></textarea>
        </div>
    </div>
    <script type="text/javascript">
        window.onload = function () { init(); }
    </script>
</body>
</html>
