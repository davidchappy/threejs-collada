<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Collada Animation Loader/Converter</title>
    <style>
        label {
            line-height: normal;
            flex: 0 0 75px;
            border-radius: 2px 0 0 2px;
            border: 1px solid rgba(147,128,108,.25);
            padding: .5em .75em;
            background-color: rgba(147,128,108,.1);
            color: #666;
            font-weight: 400;
            margin-left: 0.5em;
        }

        input, textarea {
            display: block;
            line-height: normal;
            flex: 1 0 100px;
            border-radius: 0 2px 2px 0;
            border: 1px solid rgba(147,128,108,.25);
            border-left: 0;
            padding: .5em .75em;
            margin: 0;
        }

        button {
             display: block;
            line-height: normal;
            flex: 1 0 100px;
            border-radius: 2px;
            border: 1px solid rgba(147,128,108,.25);
            padding: .5em .75em;
            margin: 0;
            margin-left: 0.5em;
        }

        #container {
            max-width: 70rem;
            flex:1;
            margin:0 auto;
        }

        .input-row {
            display: flex;
            flex-wrap: wrap;
        }

        .input-cell {
            display: flex;
            flex-wrap: wrap;
            flex:1 0 250px;
            margin-bottom: 0.5em;
        }

        body {
            display:flex;
        }
    </style>
	<script type="text/javascript" src="js/gl-matrix.js"></script>
    <script type="text/javascript" src="collada.js"></script>
    <script type="text/javascript">
        var elements = {};
        var xmlParser = null;
        var loader = null;
        var converter = null;
        var exporter = null;
        var global_data = {
            input: null,
            loaded_document: null,
            converted_document: null,
            exported_document: null
        };

        function writeLog(msg, log) {
            elements["log_"+log].textContent += msg + "\n";
            console.log(log + ":" + msg);
        }
        function clearInput() {
            elements.input.textContent = "";
            global_data.input = "";
            clearLoader();
        }
        function clearLoader() {
            elements.log_loader.textContent = "";
            global_data.loaded_document = null;
            clearConverter();
        }
        function clearConverter() {
            elements.log_converter.textContent = "";
            global_data.converted_document = null;
            clearExporter();
        }
        function clearExporter() {
            elements.log_exporter.textContent = "";
            elements.output.textContent = "";
            global_data.exported_document = null;
        }
        function onFileDrag(ev) {
            ev.preventDefault();
        }
        function onFileDrop(ev) {
            clearInput();
            writeLog("Something dropped.", "progress");
            ev.preventDefault();
            var dt = ev.dataTransfer;
            var files = dt.files;
            if (files.length == 0) {
                writeLog("You did not drop a file. Try dragging and dropping a file instead.");
                return;
            }
            if (files.length > 1) {
                writeLog("You dropped multiple files. Please only drop a single file.");
                return;
            }
            var file = files[0];
            var reader = new FileReader();
            reader.onload = onFileLoaded;
            reader.onerror = onFileError;
            writeLog("Reading dropped file...", "progress");
            reader.readAsText(file);
        }
        function onFileError() {
            writeLog("Error reading file.", "progress");
        }
        function onFileLoaded(ev) {
            writeLog("File reading finished.", "progress");
            var data = this.result;
            elements.input.textContent = data;
            global_data.input = data;
        }
        function onLoadClick() {
            clearLoader();
            writeLog("Parsing XML...", "progress");
            var xmlDoc = xmlParser.parseFromString(global_data.input, "text/xml");
            writeLog("XML parsing finished.", "progress");
            
            writeLog("Parsing COLLADA...", "progress");
            loader.loadFromXML("id", xmlDoc);
        }
        function onLoadFinished(id, doc) {
            global_data.loaded_document = doc;
            writeLog("COLLADA parsing finished", "progress");
            console.log(doc);
        }
        function onConvertClick() {
            clearConverter();
            writeLog("Converting COLLADA...", "progress");
            var converted_data = converter.convert(global_data.loaded_document);
            onConvertFinished(converted_data);
        }
        function onConvertFinished(data) {
            global_data.converted_document = data;
            writeLog("COLLADA converting finished.", "progress");
            console.log(data);
        }
        function onExportClick() {
            clearExporter();
            writeLog("Exporting COLLADA...", "progress");
            var exported_data = exporter.export(global_data.converted_document);
            onExportFinished(exported_data);
        }
        function onExportFinished(data) {
            global_data.exported_document = data;
            writeLog("COLLADA exporting finished.", "progress");
            elements.output.textContent = JSON.stringify(data);
            console.log(data);
        }
        function onColladaProgress(id, loaded, total) {
            writeLog("Collada loading progress", "progress");
        }

        function init() {
            // Find elements
            elements.input = document.getElementById("input");
            elements.log_progress = document.getElementById("log_progress");
            elements.log_loader = document.getElementById("log_loader");
            elements.log_converter = document.getElementById("log_converter");
            elements.log_exporter = document.getElementById("log_exporter");
            elements.output = document.getElementById("output");
            elements.load = document.getElementById("load");
            elements.convert = document.getElementById("convert");
            elements.export = document.getElementById("export");

            // Create COLLADA converter chain
            xmlParser = new DOMParser();

            loader = new ColladaLoader();
            loader.onFinished = onLoadFinished;
            loader.log = new ColladaLogTextArea(elements.log_loader);

            converter = new ColladaConverter();
            converter.log = new ColladaLogTextArea(elements.log_converter);

            exporter = new ColladaExporter();  
            exporter.log = new ColladaLogTextArea(elements.log_exporter);

            // Register events
            elements.input.ondragover = onFileDrag;
            elements.input.ondrop = onFileDrop;
            elements.load.onclick = onLoadClick;
            elements.convert.onclick = onConvertClick;
            elements.export.onclick = onExportClick;
        }
    </script>
</head>
<body>
    <div id="container">
        <div class="input-row input-cell">
            <label for="input">Input</label>
            <textarea id="input" rows="10" cols="40"></textarea>
        </div>
        <div class="input-row">
            <button id="load" class="input-cell">Load</button>
            <button id="convert" class="input-cell">Convert</button>
            <button id="export" class="input-cell">Export</button>
        </div>
        <div class="input-row input-cell">
            <label for="log_progress">Progress</label>
            <textarea id="log_progress" rows="10" cols="40"></textarea>
        </div>
        <div class="input-row input-cell">
            <label for="log_loader">Loader Log</label>
            <textarea id="log_loader" rows="10" cols="40"></textarea>
        </div>
        <div class="input-row input-cell">
            <label for="log_converter">Converter Log</label>
            <textarea id="log_converter" rows="10" cols="40"></textarea>
        </div>
        <div class="input-row input-cell">
            <label for="log_exporter">Exporter Log</label>
            <textarea id="log_exporter" rows="10" cols="40"></textarea>
        </div>
        <div class="input-row input-cell">
            <label for="output">Output</label>
            <textarea id="output" rows="10" cols="40"></textarea>
        </div>
    </div>
    <script type="text/javascript">
        window.onload = function () { init(); }
    </script>
</body>
</html>
