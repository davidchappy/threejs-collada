<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Collada Animation Loader/Converter</title>
    <style>
        label {
            line-height: normal;
            flex: 0 0 75px;
            border-radius: 2px 0 0 2px;
            border: 1px solid rgba(147,128,108,.25);
            padding: .5em .75em;
            background-color: rgba(147,128,108,.1);
            color: #666;
            font-weight: 400;
            margin-left: 0.5em;
        }

        input, textarea, a {
            display: block;
            line-height: normal;
            flex: 1 0 100px;
            border-radius: 0 2px 2px 0;
            border: 1px solid rgba(147,128,108,.25);
            border-left: 0;
            padding: .5em .75em;
            margin: 0;
        }

        button {
            display: block;
            line-height: normal;
            flex: 1 0 100px;
            border-radius: 2px;
            border: 1px solid rgba(147,128,108,.25);
            padding: .5em .75em;
            margin: 0;
            margin-left: 0.5em;
        }

        #container {
            max-width: 70rem;
            flex:1;
            margin:0 auto;
        }

        .input-row {
            display: flex;
            flex-wrap: wrap;
        }

        .input-cell {
            display: flex;
            flex-wrap: wrap;
            flex:1 0 250px;
            margin-bottom: 0.5em;
        }

        canvas {
            display: block;
            line-height: normal;
            flex: 1 0 100px;
            border: 1px solid rgba(147,128,108,.25);
            padding: .5em .75em;
            margin: 0;
            border-left: 0;
            min-height: 480px;
        }

        body {
            display:flex;
        }
    </style>
    <script type="text/javascript" src="js/gl-matrix.js"></script>
    <script type="text/javascript" src="collada.js"></script>
    <script type="text/javascript" src="test.js"></script>
    <script id="shader-fs" type="x-shader/x-fragment">
        precision mediump float;

        varying vec2 v_texcoord;
        varying vec3 v_normal;
        varying vec3 v_position;

        uniform vec3 u_ambient_color;
        uniform vec3 u_light_direction;
        uniform vec3 u_light_color;

        void main(void) {
            float diffuse = max(dot(v_normal, u_light_direction), 0.0);
            vec3 light = u_ambient_color + u_light_color * diffuse;
            gl_FragColor = vec4(light, 1) + vec4(0.001*v_texcoord, 0, 0);
        }
    </script>
    <script id="shader-vs" type="x-shader/x-vertex">
        attribute vec3 va_position;
        attribute vec3 va_normal;
        attribute vec2 va_texcoord;

        uniform mat4 u_modelview_matrix;
        uniform mat4 u_projection_matrix;
        uniform mat3 u_normal_matrix;

        varying vec2 v_texcoord;
        varying vec3 v_normal;
        varying vec3 v_position;

        void main(void) {
            gl_Position = u_projection_matrix * u_modelview_matrix * vec4(va_position, 1.0);
            v_texcoord = va_texcoord;
            vec4 pos = u_modelview_matrix * vec4(va_position, 1);
            v_position = pos.xyz;
            v_normal = u_normal_matrix * va_normal;
        }
    </script>
    <script id="shader-skinning-vs" type="x-shader/x-vertex">
        attribute vec3 va_position;
        attribute vec3 va_normal;
        attribute vec2 va_texcoord;
        attribute vec4 va_boneindex;
        attribute vec4 va_boneweight;

        uniform mat4 u_modelview_matrix;
        uniform mat4 u_projection_matrix;
        uniform mat3 u_normal_matrix;
        uniform mat4 u_bone_matrix[100];

        varying vec2 v_texcoord;
        varying vec3 v_normal;
        varying vec3 v_position;

        void main(void) {
            ivec4 boneindex = ivec4(va_boneindex);
            mat4 skin_mat =
                va_boneweight.x * u_bone_matrix[boneindex.x] +
                va_boneweight.y * u_bone_matrix[boneindex.y] +
                va_boneweight.z * u_bone_matrix[boneindex.z] +
                va_boneweight.w * u_bone_matrix[boneindex.w];

            vec4 world_pos = skin_mat * vec4(va_position, 1.0);
            vec4 world_normal = skin_mat * vec4(va_normal, 0.0);

            gl_Position = u_projection_matrix * u_modelview_matrix * vec4(world_pos.xyz, 1);
            v_texcoord = va_texcoord;
            vec4 pos = u_modelview_matrix * vec4(world_pos.xyz, 1);
            v_position = pos.xyz;
            v_normal = u_normal_matrix * normalize(world_normal.xyz);
        }
    </script>
</head>
<body>
    <div id="container">
        <div class="input-row">
            <div class="input-cell">
                <label for="input">Input</label>
                <textarea id="input" rows="10" cols="40"></textarea>
            </div>
            <div class="input-cell">
                <label for="output">Output</label>
                <textarea id="output" rows="10" cols="40"></textarea>
            </div>
        </div>
        <div class="input-row">
            <button id="convert" class="input-cell">Convert</button>
        </div>
        <div class="input-row">
            <div class="input-cell">
                <label for="download_json">JSON</label>
                <a id="download_json" href="" download="model.json">Download link</a>
            </div>
            <div class="input-cell">
                <label for="download_data">Data</label>
                <a id="download_data" href="" download="model.bin">Download link</a>
            </div>
        </div>
        <div class="input-row">
            <div class="input-cell">
                <label for="log_progress">Progress</label>
                <textarea id="log_progress" rows="10" cols="20"></textarea>
            </div>
            <div class="input-cell">
                <label for="log_loader">Loader Log</label>
                <textarea id="log_loader" rows="10" cols="20"></textarea>
            </div>
        </div>
        <div class="input-row">
            <div class="input-cell">
                <label for="log_converter">Converter Log</label>
                <textarea id="log_converter" rows="10" cols="40"></textarea>
            </div>
            <div class="input-cell">
                <label for="log_exporter">Exporter Log</label>
                <textarea id="log_exporter" rows="10" cols="40"></textarea>
            </div>
        </div>
        <div class="input-row input-cell">
            <label for="canvas">Preview</label>
            <canvas id="canvas" width="600" height="400"></canvas>
        </div>
    </div>
    <script type="text/javascript">
        window.onload = function () { init(); }
    </script>
</body>
</html>
